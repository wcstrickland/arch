"use strict";

require("core-js/modules/es.array.concat");

require("core-js/modules/es.array.filter");

require("core-js/modules/es.array.index-of");

require("core-js/modules/es.array.join");

require("core-js/modules/es.array.map");

require("core-js/modules/es.function.name");

require("core-js/modules/es.object.assign");

require("core-js/modules/es.object.create");

require("core-js/modules/es.object.define-property");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _traverse = _interopRequireDefault(require("@babel/traverse"));

var _jestSnapshot = require("jest-snapshot");

var _babel_parser = require("./parsers/babel_parser");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var describeVariants = Object.assign(Object.create(null), {
  describe: true,
  fdescribe: true,
  xdescribe: true
});
var base = Object.assign(Object.create(null), {
  describe: true,
  it: true,
  test: true
});
var decorators = Object.assign(Object.create(null), {
  only: true,
  skip: true
});
var validParents = Object.assign(Object.create(null), base, describeVariants, Object.assign(Object.create(null), {
  fit: true,
  xit: true,
  xtest: true
}));

var isValidMemberExpression = function isValidMemberExpression(node) {
  return node.object && base[node.object.name] && node.property && decorators[node.property.name];
};

var isDescribe = function isDescribe(node) {
  return describeVariants[node.name] || isValidMemberExpression(node) && node.object.name === 'describe';
};

var isValidParent = function isValidParent(parent) {
  return parent.callee && (validParents[parent.callee.name] || isValidMemberExpression(parent.callee));
};

var getArrayOfParents = function getArrayOfParents(path) {
  var result = [];
  var parent = path.parentPath;

  while (parent) {
    result.unshift(parent.node);
    parent = parent.parentPath;
  }

  return result;
};

var buildName = function buildName(snapshotNode, parents, position) {
  var fullName = parents.map(function (parent) {
    return parent.arguments[0].value;
  }).join(' ');
  return _jestSnapshot.utils.testNameToKey(fullName, position);
};

var Snapshot = /*#__PURE__*/function () {
  function Snapshot(parser, customMatchers, projectConfig) {
    _classCallCheck(this, Snapshot);

    this._parser = parser || _babel_parser.getASTfor;
    this._matchers = ['toMatchSnapshot', 'toThrowErrorMatchingSnapshot'].concat(customMatchers || []);
    this._projectConfig = projectConfig;
  }

  _createClass(Snapshot, [{
    key: "getMetadata",
    value: function getMetadata(filePath) {
      var _this = this;

      var verbose = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
      var fileNode;

      try {
        fileNode = this._parser(filePath);
      } catch (error) {
        if (verbose) {
          // eslint-disable-next-line no-console
          console.warn(error);
        }

        return [];
      }

      var state = {
        found: []
      };
      var Visitors = {
        Identifier: function Identifier(path, _state, matchers) {
          if (matchers.indexOf(path.node.name) >= 0) {
            _state.found.push({
              node: path.node,
              parents: getArrayOfParents(path)
            });
          }
        }
      };
      (0, _traverse["default"])(fileNode, {
        enter: function enter(path) {
          var visitor = Visitors[path.node.type];

          if (visitor != null) {
            visitor(path, state, _this._matchers);
          }
        }
      }); // NOTE if no projectConfig is given the default resolver will be used

      var snapshotResolver = (0, _jestSnapshot.buildSnapshotResolver)(this._projectConfig || {});
      var snapshotPath = snapshotResolver.resolveSnapshotPath(filePath);

      var snapshots = _jestSnapshot.utils.getSnapshotData(snapshotPath, 'none').data;

      var lastParent = null;
      var count = 1;
      return state.found.map(function (snapshotNode) {
        var parents = snapshotNode.parents.filter(isValidParent);
        var innerAssertion = parents[parents.length - 1];

        if (lastParent !== innerAssertion) {
          lastParent = innerAssertion;
          count = 1;
        }

        var result = {
          content: undefined,
          count: count,
          exists: false,
          name: '',
          node: snapshotNode.node
        };
        count += 1;

        if (!innerAssertion || isDescribe(innerAssertion.callee)) {
          // An expectation inside describe never gets executed.
          return result;
        }

        result.name = buildName(snapshotNode, parents, result.count);

        if (snapshots[result.name]) {
          result.exists = true;
          result.content = snapshots[result.name];
        }

        return result;
      });
    }
  }]);

  return Snapshot;
}();

exports["default"] = Snapshot;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TbmFwc2hvdC5qcyJdLCJuYW1lcyI6WyJkZXNjcmliZVZhcmlhbnRzIiwiT2JqZWN0IiwiYXNzaWduIiwiY3JlYXRlIiwiZGVzY3JpYmUiLCJmZGVzY3JpYmUiLCJ4ZGVzY3JpYmUiLCJiYXNlIiwiaXQiLCJ0ZXN0IiwiZGVjb3JhdG9ycyIsIm9ubHkiLCJza2lwIiwidmFsaWRQYXJlbnRzIiwiZml0IiwieGl0IiwieHRlc3QiLCJpc1ZhbGlkTWVtYmVyRXhwcmVzc2lvbiIsIm5vZGUiLCJvYmplY3QiLCJuYW1lIiwicHJvcGVydHkiLCJpc0Rlc2NyaWJlIiwiaXNWYWxpZFBhcmVudCIsInBhcmVudCIsImNhbGxlZSIsImdldEFycmF5T2ZQYXJlbnRzIiwicGF0aCIsInJlc3VsdCIsInBhcmVudFBhdGgiLCJ1bnNoaWZ0IiwiYnVpbGROYW1lIiwic25hcHNob3ROb2RlIiwicGFyZW50cyIsInBvc2l0aW9uIiwiZnVsbE5hbWUiLCJtYXAiLCJhcmd1bWVudHMiLCJ2YWx1ZSIsImpvaW4iLCJ1dGlscyIsInRlc3ROYW1lVG9LZXkiLCJTbmFwc2hvdCIsInBhcnNlciIsImN1c3RvbU1hdGNoZXJzIiwicHJvamVjdENvbmZpZyIsIl9wYXJzZXIiLCJnZXRBU1Rmb3IiLCJfbWF0Y2hlcnMiLCJjb25jYXQiLCJfcHJvamVjdENvbmZpZyIsImZpbGVQYXRoIiwidmVyYm9zZSIsImZpbGVOb2RlIiwiZXJyb3IiLCJjb25zb2xlIiwid2FybiIsInN0YXRlIiwiZm91bmQiLCJWaXNpdG9ycyIsIklkZW50aWZpZXIiLCJfc3RhdGUiLCJtYXRjaGVycyIsImluZGV4T2YiLCJwdXNoIiwiZW50ZXIiLCJ2aXNpdG9yIiwidHlwZSIsInNuYXBzaG90UmVzb2x2ZXIiLCJzbmFwc2hvdFBhdGgiLCJyZXNvbHZlU25hcHNob3RQYXRoIiwic25hcHNob3RzIiwiZ2V0U25hcHNob3REYXRhIiwiZGF0YSIsImxhc3RQYXJlbnQiLCJjb3VudCIsImZpbHRlciIsImlubmVy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QUFDNkMsTUFBUixHQUFpQixDQUFsQixDQUE5Qjs7QUFFQSxZQUFJSixVQUFVLEtBQUtHLGNBQW5CLEVBQW1DO0FBQ2pDSCxVQUFBQSxVQUFVLEdBQUdHLGNBQWI7QUFDQUYsVUFBQUEsS0FBSyxHQUFHLENBQVI7QUFDRDs7QUFFRCxZQUFNL0MsTUFBTSxHQUFHO0FBQ2JtRCxVQUFBQSxPQUFPLEVBQUVDLFNBREk7QUFFYkwsVUFBQUEsS0FBSyxFQUFMQSxLQUZhO0FBR2JNLFVBQUFBLE1BQU0sRUFBRSxLQUhLO0FBSWI3RCxVQUFBQSxJQUFJLEVBQUUsRUFKTztBQUtiRixVQUFBQSxJQUFJLEVBQUVjLFlBQVksQ0FBQ2Q7QUFMTixTQUFmO0FBT0F5RCxRQUFBQSxLQUFLLElBQUksQ0FBVDs7QUFFQSxZQUFJLENBQUNFLGNBQUQsSUFBbUJ2RCxVQUFVLENBQUN1RCxjQUFjLENBQUNwRCxNQUFoQixDQUFqQyxFQUEwRDtBQUN4RDtBQUNBLGlCQUFPRyxNQUFQO0FBQ0Q7O0FBRURBLFFBQUFBLE1BQU0sQ0FBQ1IsSUFBUCxHQUFjVyxTQUFTLENBQUNDLFlBQUQsRUFBZUMsT0FBZixFQUF3QkwsTUFBTSxDQUFDK0MsS0FBL0IsQ0FBdkI7O0FBRUEsWUFBSUosU0FBUyxDQUFDM0MsTUFBTSxDQUFDUixJQUFSLENBQWIsRUFBNEI7QUFDMUJRLFVBQUFBLE1BQU0sQ0FBQ3FELE1BQVAsR0FBZ0IsSUFBaEI7QUFDQXJELFVBQUFBLE1BQU0sQ0FBQ21ELE9BQVAsR0FBaUJSLFNBQVMsQ0FBQzNDLE1BQU0sQ0FBQ1IsSUFBUixDQUExQjtBQUNEOztBQUNELGVBQU9RLE1BQVA7QUFDRCxPQTlCTSxDQUFQO0FBK0JEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTQtcHJlc2VudCwgRmFjZWJvb2ssIEluYy4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBCU0Qtc3R5bGUgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4gQW4gYWRkaXRpb25hbCBncmFudFxuICogb2YgcGF0ZW50IHJpZ2h0cyBjYW4gYmUgZm91bmQgaW4gdGhlIFBBVEVOVFMgZmlsZSBpbiB0aGUgc2FtZSBkaXJlY3RvcnkuXG4gKlxuICogQGZsb3dcbiAqL1xuXG5pbXBvcnQgdHJhdmVyc2UgZnJvbSAnQGJhYmVsL3RyYXZlcnNlJztcbmltcG9ydCB7YnVpbGRTbmFwc2hvdFJlc29sdmVyLCB1dGlsc30gZnJvbSAnamVzdC1zbmFwc2hvdCc7XG5pbXBvcnQgdHlwZSB7UHJvamVjdENvbmZpZ30gZnJvbSAnLi4vdHlwZXMvQ29uZmlnJztcblxuaW1wb3J0IHtnZXRBU1Rmb3J9IGZyb20gJy4vcGFyc2Vycy9iYWJlbF9wYXJzZXInO1xuXG50eXBlIE5vZGUgPSBhbnk7XG5cbnR5cGUgU25hcHNob3RNZXRhZGF0YSA9IHtcbiAgZXhpc3RzOiB0cnVlIHwgZmFsc2UsXG4gIG5hbWU6IHN0cmluZyxcbiAgbm9kZTogTm9kZSxcbiAgY29udGVudD86IHN0cmluZyxcbn07XG5cbmNvbnN0IGRlc2NyaWJlVmFyaWFudHMgPSBPYmplY3QuYXNzaWduKChPYmplY3QuY3JlYXRlKG51bGwpOiB7W3N0cmluZ106IGJvb2xlYW4sIF9fcHJvdG9fXzogbnVsbH0pLCB7XG4gIGRlc2NyaWJlOiB0cnVlLFxuICBmZGVzY3JpYmU6IHRydWUsXG4gIHhkZXNjcmliZTogdHJ1ZSxcbn0pO1xuY29uc3QgYmFzZSA9IE9iamVjdC5hc3NpZ24oKE9iamVjdC5jcmVhdGUobnVsbCk6IHtbc3RyaW5nXTogYm9vbGVhbiwgX19wcm90b19fOiBudWxsfSksIHtcbiAgZGVzY3JpYmU6IHRydWUsXG4gIGl0OiB0cnVlLFxuICB0ZXN0OiB0cnVlLFxufSk7XG5jb25zdCBkZWNvcmF0b3JzID0gT2JqZWN0LmFzc2lnbigoT2JqZWN0LmNyZWF0ZShudWxsKToge1tzdHJpbmddOiBib29sZWFuLCBfX3Byb3RvX186IG51bGx9KSwge1xuICBvbmx5OiB0cnVlLFxuICBza2lwOiB0cnVlLFxufSk7XG5cbmNvbnN0IHZhbGlkUGFyZW50cyA9IE9iamVjdC5hc3NpZ24oXG4gIChPYmplY3QuY3JlYXRlKG51bGwpOiBhbnkpLFxuICBiYXNlLFxuICBkZXNjcmliZVZhcmlhbnRzLFxuICBPYmplY3QuYXNzaWduKChPYmplY3QuY3JlYXRlKG51bGwpOiB7W3N0cmluZ106IGJvb2xlYW4sIF9fcHJvdG9fXzogbnVsbH0pLCB7XG4gICAgZml0OiB0cnVlLFxuICAgIHhpdDogdHJ1ZSxcbiAgICB4dGVzdDogdHJ1ZSxcbiAgfSlcbik7XG5cbmNvbnN0IGlzVmFsaWRNZW1iZXJFeHByZXNzaW9uID0gbm9kZSA9PlxuICBub2RlLm9iamVjdCAmJiBiYXNlW25vZGUub2JqZWN0Lm5hbWVdICYmIG5vZGUucHJvcGVydHkgJiYgZGVjb3JhdG9yc1tub2RlLnByb3BlcnR5Lm5hbWVdO1xuXG5jb25zdCBpc0Rlc2NyaWJlID0gbm9kZSA9PlxuICBkZXNjcmliZVZhcmlhbnRzW25vZGUubmFtZV0gfHwgKGlzVmFsaWRNZW1iZXJFeHByZXNzaW9uKG5vZGUpICYmIG5vZGUub2JqZWN0Lm5hbWUgPT09ICdkZXNjcmliZScpO1xuXG5jb25zdCBpc1ZhbGlkUGFyZW50ID0gcGFyZW50ID0+XG4gIHBhcmVudC5jYWxsZWUgJiYgKHZhbGlkUGFyZW50c1twYXJlbnQuY2FsbGVlLm5hbWVdIHx8IGlzVmFsaWRNZW1iZXJFeHByZXNzaW9uKHBhcmVudC5jYWxsZWUpKTtcblxuY29uc3QgZ2V0QXJyYXlPZlBhcmVudHMgPSBwYXRoID0+IHtcbiAgY29uc3QgcmVzdWx0ID0gW107XG4gIGxldCBwYXJlbnQgPSBwYXRoLnBhcmVudFBhdGg7XG4gIHdoaWxlIChwYXJlbnQpIHtcbiAgICByZXN1bHQudW5zaGlmdChwYXJlbnQubm9kZSk7XG4gICAgcGFyZW50ID0gcGFyZW50LnBhcmVudFBhdGg7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbmNvbnN0IGJ1aWxkTmFtZTogKHNuYXBzaG90Tm9kZTogTm9kZSwgcGFyZW50czogQXJyYXk8Tm9kZT4sIHBvc2l0aW9uOiBudW1iZXIpID0+IHN0cmluZyA9IChcbiAgc25hcHNob3ROb2RlLFxuICBwYXJlbnRzLFxuICBwb3NpdGlvblxuKSA9PiB7XG4gIGNvbnN0IGZ1bGxOYW1lID0gcGFyZW50cy5tYXAocGFyZW50ID0+IHBhcmVudC5hcmd1bWVudHNbMF0udmFsdWUpLmpvaW4oJyAnKTtcblxuICByZXR1cm4gdXRpbHMudGVzdE5hbWVUb0tleShmdWxsTmFtZSwgcG9zaXRpb24pO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU25hcHNob3Qge1xuICBfcGFyc2VyOiBGdW5jdGlvbjtcblxuICBfbWF0Y2hlcnM6IEFycmF5PHN0cmluZz47XG5cbiAgX3Byb2plY3RDb25maWc6ID9Qcm9qZWN0Q29uZmlnO1xuXG4gIGNvbnN0cnVjdG9yKHBhcnNlcjogYW55LCBjdXN0b21NYXRjaGVycz86IEFycmF5PHN0cmluZz4sIHByb2plY3RDb25maWc/OiBQcm9qZWN0Q29uZmlnKSB7XG4gICAgdGhpcy5fcGFyc2VyID0gcGFyc2VyIHx8IGdldEFTVGZvcjtcbiAgICB0aGlzLl9tYXRjaGVycyA9IFsndG9NYXRjaFNuYXBzaG90JywgJ3RvVGhyb3dFcnJvck1hdGNoaW5nU25hcHNob3QnXS5jb25jYXQoY3VzdG9tTWF0Y2hlcnMgfHwgW10pO1xuICAgIHRoaXMuX3Byb2plY3RDb25maWcgPSBwcm9qZWN0Q29uZmlnO1xuICB9XG5cbiAgZ2V0TWV0YWRhdGEoZmlsZVBhdGg6IHN0cmluZywgdmVyYm9zZTogYm9vbGVhbiA9IGZhbHNlKTogQXJyYXk8U25hcHNob3RNZXRhZGF0YT4ge1xuICAgIGxldCBmaWxlTm9kZTtcbiAgICB0cnkge1xuICAgICAgZmlsZU5vZGUgPSB0aGlzLl9wYXJzZXIoZmlsZVBhdGgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAodmVyYm9zZSkge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgICBjb25zb2xlLndhcm4oZXJyb3IpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBjb25zdCBzdGF0ZSA9IHtcbiAgICAgIGZvdW5kOiBbXSxcbiAgICB9O1xuICAgIGNvbnN0IFZpc2l0b3JzID0ge1xuICAgICAgSWRlbnRpZmllcihwYXRoLCBfc3RhdGUsIG1hdGNoZXJzKSB7XG4gICAgICAgIGlmIChtYXRjaGVycy5pbmRleE9mKHBhdGgubm9kZS5uYW1lKSA+PSAwKSB7XG4gICAgICAgICAgX3N0YXRlLmZvdW5kLnB1c2goe1xuICAgICAgICAgICAgbm9kZTogcGF0aC5ub2RlLFxuICAgICAgICAgICAgcGFyZW50czogZ2V0QXJyYXlPZlBhcmVudHMocGF0aCksXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHRyYXZlcnNlKGZpbGVOb2RlLCB7XG4gICAgICBlbnRlcjogcGF0aCA9PiB7XG4gICAgICAgIGNvbnN0IHZpc2l0b3IgPSBWaXNpdG9yc1twYXRoLm5vZGUudHlwZV07XG4gICAgICAgIGlmICh2aXNpdG9yICE9IG51bGwpIHtcbiAgICAgICAgICB2aXNpdG9yKHBhdGgsIHN0YXRlLCB0aGlzLl9tYXRjaGVycyk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBOT1RFIGlmIG5vIHByb2plY3RDb25maWcgaXMgZ2l2ZW4gdGhlIGRlZmF1bHQgcmVzb2x2ZXIgd2lsbCBiZSB1c2VkXG4gICAgY29uc3Qgc25hcHNob3RSZXNvbHZlciA9IGJ1aWxkU25hcHNob3RSZXNvbHZlcih0aGlzLl9wcm9qZWN0Q29uZmlnIHx8IHt9KTtcbiAgICBjb25zdCBzbmFwc2hvdFBhdGggPSBzbmFwc2hvdFJlc29sdmVyLnJlc29sdmVTbmFwc2hvdFBhdGgoZmlsZVBhdGgpO1xuICAgIGNvbnN0IHNuYXBzaG90cyA9IHV0aWxzLmdldFNuYXBzaG90RGF0YShzbmFwc2hvdFBhdGgsICdub25lJykuZGF0YTtcbiAgICBsZXQgbGFzdFBhcmVudCA9IG51bGw7XG4gICAgbGV0IGNvdW50ID0gMTtcblxuICAgIHJldHVybiBzdGF0ZS5mb3VuZC5tYXAoc25hcHNob3ROb2RlID0+IHtcbiAgICAgIGNvbnN0IHBhcmVudHMgPSBzbmFwc2hvdE5vZGUucGFyZW50cy5maWx0ZXIoaXNWYWxpZFBhcmVudCk7XG4gICAgICBjb25zdCBpbm5lckFzc2VydGlvbiA9IHBhcmVudHNbcGFyZW50cy5sZW5ndGggLSAxXTtcblxuICAgICAgaWYgKGxhc3RQYXJlbnQgIT09IGlubmVyQXNzZXJ0aW9uKSB7XG4gICAgICAgIGxhc3RQYXJlbnQgPSBpbm5lckFzc2VydGlvbjtcbiAgICAgICAgY291bnQgPSAxO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZXN1bHQgPSB7XG4gICAgICAgIGNvbnRlbnQ6IHVuZGVmaW5lZCxcbiAgICAgICAgY291bnQsXG4gICAgICAgIGV4aXN0czogZmFsc2UsXG4gICAgICAgIG5hbWU6ICcnLFxuICAgICAgICBub2RlOiBzbmFwc2hvdE5vZGUubm9kZSxcbiAgICAgIH07XG4gICAgICBjb3VudCArPSAxO1xuXG4gICAgICBpZiAoIWlubmVyQXNzZXJ0aW9uIHx8IGlzRGVzY3JpYmUoaW5uZXJBc3NlcnRpb24uY2FsbGVlKSkge1xuICAgICAgICAvLyBBbiBleHBlY3RhdGlvbiBpbnNpZGUgZGVzY3JpYmUgbmV2ZXIgZ2V0cyBleGVjdXRlZC5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH1cblxuICAgICAgcmVzdWx0Lm5hbWUgPSBidWlsZE5hbWUoc25hcHNob3ROb2RlLCBwYXJlbnRzLCByZXN1bHQuY291bnQpO1xuXG4gICAgICBpZiAoc25hcHNob3RzW3Jlc3VsdC5uYW1lXSkge1xuICAgICAgICByZXN1bHQuZXhpc3RzID0gdHJ1ZTtcbiAgICAgICAgcmVzdWx0LmNvbnRlbnQgPSBzbmFwc2hvdHNbcmVzdWx0Lm5hbWVdO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9KTtcbiAgfVxufVxuIl19